language: php
php:
  - 7.2

sudo: false

services:
  - mysql

env:
  global:
    - PLUGIN_NAME=FroshPlatformBunnycdnMediaStorage

cache:
  directories:
    - "${HOME}/.composer/cache/files"

install:
  - composer install

script:
  - "./build.sh $TRAVIS_TAG"

stages:
  - test
  -   name: Store-Check
      if: tag IS blank AND env(PLUGIN_ID) IS present AND type != pull_request
  -   name: Store-Sync
      if: branch = master AND env(PLUGIN_ID) IS present AND type != pull_request
  -   name: Store-Deploy
      if: tag IS present

jobs:
  include:
    -   stage: Store-Check
        php: 7.3
        before_script: skip
        install:
          - ./build.sh master
          - wget 'https://github.com/FriendsOfShopware/FroshPluginUploader/releases/download/0.2.2/frosh-plugin-upload.phar' -O frosh-plugin-upload.phar
        script:
          - php frosh-plugin-upload.phar plugin:validate ${TRAVIS_BUILD_DIR}/${PLUGIN_NAME}*.zip
    -   stage: Store-Sync
        before_script: skip
        php: 7.3
        install:
          - wget 'https://github.com/FriendsOfShopware/FroshPluginUploader/releases/download/0.2.2/frosh-plugin-upload.phar' -O frosh-plugin-upload.phar
        script:
          - php frosh-plugin-upload.phar plugin:update ${TRAVIS_BUILD_DIR}/
    -   stage: Store-Deploy
        before_script: skip
        php: 7.3
        install:
          - wget 'https://github.com/FriendsOfShopware/FroshPluginUploader/releases/download/0.2.2/frosh-plugin-upload.phar' -O frosh-plugin-upload.phar
        script:
          - ./build.sh
          - php frosh-plugin-upload.phar plugin:upload ${TRAVIS_BUILD_DIR}/${PLUGIN_NAME}*.zip

deploy:
  provider: releases
  api_key:
    secure: w6h7FHaxKEZAqrblWt662KXXel4KmxWN0fNGtHeoLXqLrTDUOH658gr/KzbZzPj6qKR4wL8jlcDBKBqS767CKvKyC2vD2okYEiE6ixIQVYjREHpW9AZcmZkuQE6nmLOnHiun0tbcWanbKLaRt5GWY+23Nz3VwnRaHJCz6pikDRHSWTQey51VjGrkw/zorsVUTeXqwAx3To9R2ga1c8ag9kGE/UhS3Y5xYxquSbZi84N4MSfeQsuZ6oj7Am7kCldzjbC4PLPyzgHXLAVp0WqFsXA3l/FWLGSfHkGFeX9oG5okx7E2uXYu29vXWv6v7FuQFomzLbLakGthmD13OijXuoOJWr0mVfYwWTJGyQxEeqzOKa5TzhmHIvuUiHhsRtGekg5czcOdf23Jz/LRUNoKYQVHBu2sNTTciMtrkIHuC167CCtBUISNLxMZtRts4NxSYCI+AL62dXPPYwbPZnvKD9+U7ruiZHACrAXIT2RMTnqK4o1ybeF2zqibh2aA/6LHVotC7UwhryUe6eLy4/T6aK23b3nUJvyP7wiWubSX57VoI6I9Ck0m9WcHa7vnjOnQACK8KO9L/51f6CwK74APqmPWyRwflln1UQ3S6NMf5sFvcuixoQPGzXLOHqhYow1b4vqnMCTCi0SiAT4FFbnTt0aX9Jxu/F0vgHEXAdmCY04=
  file_glob: true
  file: $PLUGIN_NAME*.zip
  skip_cleanup: true
  on:
    repo: FriendsOfShopware/FroshBunnycdnMediaStorage
    tags: true